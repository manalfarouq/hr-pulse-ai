# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main]

jobs:

  lint:
    name: Linting (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run Ruff
        run: uv run ruff check backend/ tests/

  tests:
    name: Tests (Pytest)
    runs-on: ubuntu-latest
    needs: lint
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      AZURE_LANGUAGE_ENDPOINT: ${{ secrets.AZURE_LANGUAGE_ENDPOINT }}
      AZURE_LANGUAGE_KEY: ${{ secrets.AZURE_LANGUAGE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Install ODBC Driver 18
        run: |
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
            | sudo tee /usr/share/keyrings/microsoft-prod.asc > /dev/null
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.asc] https://packages.microsoft.com/ubuntu/22.04/prod jammy main" \
            | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run Pytest
        run: uv run pytest tests/ -v

  docker:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -f Dockerfile.backend -t hr-pulse-backend .